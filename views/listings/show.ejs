<% layout("/layouts/boilerplate") %>
<style>
    .image-gallery {
        position: relative;
        width: 100%;
        max-width: 600px;
        margin: 0 auto;
    }
    .gallery-img {
        width: 100%;
        height: 400px;
        object-fit: cover;
        border-radius: 8px;
    }
    .gallery-nav-btn {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        background-color: rgba(0, 0, 0, 0.5);
        color: white;
        border: none;
        font-size: 24px;
        padding: 10px 15px;
        cursor: pointer;
        border-radius: 4px;
        transition: background-color 0.3s ease;
        z-index: 10;
    }
    .gallery-nav-btn:hover {
        background-color: rgba(0, 0, 0, 0.8);
    }
    .gallery-nav-prev {
        left: 10px;
    }
    .gallery-nav-next {
        right: 10px;
    }
    .gallery-counter {
        position: absolute;
        bottom: 15px;
        right: 15px;
        background-color: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 8px 12px;
        border-radius: 4px;
        font-size: 14px;
        font-weight: bold;
        z-index: 15;
    }
    .gallery-dots {
        text-align: center;
        margin-top: 10px;
    }
    .dot {
        height: 10px;
        width: 10px;
        margin: 0 5px;
        background-color: #bbb;
        border-radius: 50%;
        display: inline-block;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }
    .dot.active {
        background-color: #717171;
    }
</style>
<div class="row mt-3">
    <div class="col-8 offset-3">
        <h3><%= listing.title %></h3>
    </div>    
        <div class="card col-6 offset-3 show-card listing-card">
            <div class="image-gallery">
                <img id="galleryImg" src="<%= listing.images && listing.images.length > 0 ? listing.images[0].url : listing.image.url %>" class="card-img-top gallery-img" alt="listing_img">
                <% if(listing.images && listing.images.length > 1) { %>
                    <button class="gallery-nav-btn gallery-nav-prev" onclick="changeImage(-1)">&#10094;</button>
                    <button class="gallery-nav-btn gallery-nav-next" onclick="changeImage(1)">&#10095;</button>
                    <div class="gallery-dots" id="dotsContainer"></div>
                <% } %>
            </div>
            <div class="card-body">
                    <p class="card-text">Owned by: <b><i><%= listing.owner.username %></i></b></p>
                    <p class="card-text"><%= listing.description %><br></p>
                    <p class="card-text">&#8377;<%= listing.price.toLocaleString("en-IN") %><br></p>
                    <p class="card-text"><%= listing.location %><br></p>
                    <p class="card-text"><%= listing.country %></p>
                <!-- <p class="card-text"><small class="text-body-secondary">Last updated 3 mins ago</small></p> -->
            </div>
        </div>

        <script>
            let currentImageIndex = 0;
            let images = [];
            
            // Initialize the images array directly from server data
            (function() {
                // Check if listing has images array
                const imagesFromServer = <%- JSON.stringify(listing.images && listing.images.length > 0 ? listing.images : [listing.image]) %>;
                
                if(Array.isArray(imagesFromServer) && imagesFromServer.length > 0) {
                    images = imagesFromServer;
                } else {
                    images = [{url: 'https://unsplash.com/photos/coconut-tree-near-body-of-water-HfIex7qwTlI'}];
                }
                
                // Initialize dots
                initializeDots();
                console.log('Gallery initialized with', images.length, 'images');
            })();
            
            function initializeDots() {
                const dotsContainer = document.getElementById('dotsContainer');
                if(!dotsContainer) return;
                
                dotsContainer.innerHTML = ''; // Clear existing dots
                
                images.forEach((img, index) => {
                    const dot = document.createElement('span');
                    dot.className = 'dot' + (index === 0 ? ' active' : '');
                    dot.style.cursor = 'pointer';
                    dot.onclick = function() {
                        goToImage(index);
                    };
                    dotsContainer.appendChild(dot);
                });
            }
            
            function changeImage(n) {
                const newIndex = currentImageIndex + n;
                goToImage(newIndex);
            }
            
            function goToImage(n) {
                // Calculate new index with wraparound
                if(n >= images.length) {
                    currentImageIndex = 0;
                } else if(n < 0) {
                    currentImageIndex = images.length - 1;
                } else {
                    currentImageIndex = n;
                }
                
                console.log('Going to image', currentImageIndex + 1, 'of', images.length);
                
                // Update main image
                const galleryImg = document.getElementById('galleryImg');
                if(galleryImg && images[currentImageIndex]) {
                    galleryImg.style.opacity = '0.5';
                    galleryImg.src = images[currentImageIndex].url;
                    galleryImg.onload = function() {
                        galleryImg.style.opacity = '1';
                    };
                }
                
                // Update counter
                const currentImgSpan = document.getElementById('currentImg');
                if(currentImgSpan) {
                    currentImgSpan.textContent = currentImageIndex + 1;
                }
                
                // Update dots
                const dots = document.querySelectorAll('.dot');
                dots.forEach((dot, index) => {
                    if(index === currentImageIndex) {
                        dot.classList.add('active');
                    } else {
                        dot.classList.remove('active');
                    }
                });
            }
        </script>

        <div class="row mb-5">
        <% if(currUser && currUser._id.equals(listing.owner._id)){ %>    
            <div class="col-6 offset-3">
                <div class="d-flex gap-3">

                    <form action="/listings/<%= listing._id %>/edit" method="get">
                        <button class="btn edit-btn btn-dark action-btn">Edit</button>
                    </form>

                    <form method="post" action="/listings/<%= listing._id %>/?_method=DELETE">
                        <button class="btn btn-dark action-btn">Delete</button>
                    </form>

                </div>
            </div>
        <% } %>    
    <div class="col-8 offset-3 mb-3">
    <hr>
    <% if(currUser){ %>
        <h4>Leave a Review</h4>
            <form action="/listings/<%= listing._id %>/reviews" method="post" class="needs-validation" novalidate>
                <div class="mt-3 mb-3">
                <label for="rating" class="form-label">Rating</label>    
                <fieldset class="starability-slot">    
                <input type="radio" id="no-rate" class="input-no-rate" name="review[rating]" value="1" checked aria-label="No rating." />
                <input type="radio" id="first-rate1" name="review[rating]" value="1" />
                <label for="first-rate1" title="Terrible">1 star</label>
                <input type="radio" id="first-rate2" name="review[rating]" value="2" />
                <label for="first-rate2" title="Not good">2 stars</label>
                <input type="radio" id="first-rate3" name="review[rating]" value="3" />
                <label for="first-rate3" title="Average">3 stars</label>
                <input type="radio" id="first-rate4" name="review[rating]" value="4" />
                <label for="first-rate4" title="Very good">4 stars</label>
                <input type="radio" id="first-rate5" name="review[rating]" value="5" />
                <label for="first-rate5" title="Amazing">5 stars</label>
                </fieldset>
                </div> 

                <div  class="mt-3 mb-3">
                    <label for="comments">Comments</label>
                    <textarea name="review[comment]" id="comments" cols="30" rows="5" class="form-control" required ></textarea>
                    <div class="invalid-feedback">Please add comment</div>
                </div>
                    <button class="btn btn-outline-dark">Submit</button>
            </form>
    <% } %>
        <% if(listing.reviews.length > 0){ %>
            <div class="row">
                <p><b>All Reviews</b></p>
                <% for(review of listing.reviews){ %>
                    <div class="card col-5 mb-3 ms-3">
                        <div class="card-body">
                            <h5 class="card-title">@<%=review.author.username %></h5>
                            <p class="starability-result card-text" data-rating=<%= review.rating %>></p>
                            <p class="card-text"><%= review.comment %></p>
                            <form method="post" action="/listings/<%= listing._id %>/reviews/<%= review._id %>?_method=DELETE">
                                <button class=" btn btn-dark btn-sm">Delete</button>
                            </form>
                        </div>
                        
                    </div>
                <% } %>
            </div>
        <% } %>    
        </div>
        <div class="col-6 offset-3 mb-3">
            <h3>Where you'll be</h3>
                <div id="map"></div>
        </div>
    </div>

</div>
<script>
    const mapToken = "<%- process.env.MAP_TOKEN %>";
    const listing = <%- JSON.stringify(listing) %>;
</script>
<script src="/js/map.js"></script>